const fs = require('fs')
const path = require('path')

console.log('üîß CORRE√á√ÉO AUTOM√ÅTICA DE PROBLEMAS - Supabase')
console.log('=' .repeat(50))

// Fun√ß√£o para verificar e criar arquivo .env.local
function verificarArquivoEnv() {
  console.log('üìÅ Verificando arquivo .env.local...')
  
  if (!fs.existsSync('.env.local')) {
    console.log('‚ùå Arquivo .env.local n√£o encontrado!')
    console.log('üìù Criando arquivo .env.local...')
    
    const templateEnv = `# Configura√ß√µes do Supabase - MentoriaApp
NEXT_PUBLIC_SUPABASE_URL=https://SEU_PROJETO.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# INSTRU√á√ïES:
# 1. Acesse: https://supabase.com/dashboard
# 2. Selecione seu projeto
# 3. V√° em Settings ‚Üí API
# 4. Copie a "Project URL" e cole acima
# 5. Copie a "anon public" key e cole acima
# 6. Salve este arquivo
`
    
    try {
      fs.writeFileSync('.env.local', templateEnv)
      console.log('‚úÖ Arquivo .env.local criado com sucesso!')
      console.log('‚ö†Ô∏è  A√á√ÉO NECESS√ÅRIA: Configure suas credenciais do Supabase')
      console.log('üìã Edite o arquivo .env.local com suas credenciais reais')
      return false
    } catch (error) {
      console.log(`‚ùå Erro ao criar arquivo: ${error.message}`)
      return false
    }
  } else {
    console.log('‚úÖ Arquivo .env.local encontrado!')
    
    // Ler e verificar conte√∫do
    try {
      const conteudo = fs.readFileSync('.env.local', 'utf8')
      
      const temUrl = conteudo.includes('NEXT_PUBLIC_SUPABASE_URL=') && 
                     !conteudo.includes('SEU_PROJETO.supabase.co')
      const temKey = conteudo.includes('NEXT_PUBLIC_SUPABASE_ANON_KEY=') && 
                     !conteudo.includes('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...')
      
      console.log(`   üîó SUPABASE_URL configurada: ${temUrl ? '‚úÖ' : '‚ùå'}`)
      console.log(`   üîë SUPABASE_ANON_KEY configurada: ${temKey ? '‚úÖ' : '‚ùå'}`)
      
      if (!temUrl || !temKey) {
        console.log('‚ö†Ô∏è  Vari√°veis n√£o configuradas corretamente!')
        console.log('üìã Edite o arquivo .env.local com suas credenciais reais')
        return false
      }
      
      return true
    } catch (error) {
      console.log(`‚ùå Erro ao ler arquivo: ${error.message}`)
      return false
    }
  }
}

// Fun√ß√£o para testar conex√£o b√°sica
async function testarConexaoBasica() {
  console.log('\nüîå Testando conex√£o b√°sica com Supabase...')
  
  // Carregar vari√°veis do .env.local manualmente
  if (fs.existsSync('.env.local')) {
    const envContent = fs.readFileSync('.env.local', 'utf8')
    const lines = envContent.split('\n')
    
    let supabaseUrl = null
    let supabaseKey = null
    
    for (const line of lines) {
      if (line.startsWith('NEXT_PUBLIC_SUPABASE_URL=')) {
        supabaseUrl = line.split('=')[1]?.trim()
      }
      if (line.startsWith('NEXT_PUBLIC_SUPABASE_ANON_KEY=')) {
        supabaseKey = line.split('=')[1]?.trim()
      }
    }
    
    if (!supabaseUrl || !supabaseKey) {
      console.log('‚ùå Credenciais n√£o encontradas no .env.local')
      return false
    }
    
    if (supabaseUrl.includes('SEU_PROJETO') || supabaseKey.includes('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...')) {
      console.log('‚ùå Credenciais ainda s√£o templates - configure com valores reais')
      return false
    }
    
    console.log('‚úÖ Credenciais encontradas')
    console.log(`   URL: ${supabaseUrl.substring(0, 30)}...`)
    console.log(`   KEY: ${supabaseKey.substring(0, 20)}...`)
    
    // Teste de ping usando fetch nativo
    try {
      console.log('üèì Fazendo ping no Supabase...')
      
      const response = await fetch(`${supabaseUrl}/rest/v1/`, {
        method: 'GET',
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${supabaseKey}`,
          'Content-Type': 'application/json'
        }
      })
      
      if (response.ok) {
        console.log('‚úÖ Ping no Supabase: SUCESSO!')
        console.log(`   Status: ${response.status}`)
        return { supabaseUrl, supabaseKey }
      } else {
        console.log(`‚ùå Ping no Supabase: FALHOU!`)
        console.log(`   Status: ${response.status}`)
        console.log(`   Verifique se as credenciais est√£o corretas`)
        return false
      }
      
    } catch (error) {
      console.log(`‚ùå Erro no ping: ${error.message}`)
      return false
    }
  } else {
    console.log('‚ùå Arquivo .env.local n√£o encontrado')
    return false
  }
}

// Fun√ß√£o para verificar tabelas
async function verificarTabelas(credentials) {
  console.log('\nüóÑÔ∏è Verificando tabelas do banco...')
  
  const { supabaseUrl, supabaseKey } = credentials
  
  const tabelas = ['usuarios', 'agendamentos', 'configuracoes_mentor']
  let tabelasOk = 0
  
  for (const tabela of tabelas) {
    try {
      console.log(`   Verificando tabela: ${tabela}`)
      
      const response = await fetch(`${supabaseUrl}/rest/v1/${tabela}?select=*&limit=1`, {
        method: 'GET',
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${supabaseKey}`,
          'Content-Type': 'application/json'
        }
      })
      
      if (response.ok) {
        console.log(`   ‚úÖ Tabela '${tabela}': OK`)
        tabelasOk++
      } else if (response.status === 404) {
        console.log(`   ‚ùå Tabela '${tabela}': N√ÉO EXISTE`)
      } else {
        console.log(`   ‚ö†Ô∏è  Tabela '${tabela}': Erro ${response.status}`)
      }
      
    } catch (error) {
      console.log(`   ‚ùå Erro ao verificar '${tabela}': ${error.message}`)
    }
  }
  
  console.log(`\nüìä Resultado: ${tabelasOk}/3 tabelas funcionando`)
  return tabelasOk === 3
}

// Fun√ß√£o para criar script SQL
function criarScriptSQL() {
  console.log('\nüìù Criando script SQL para criar tabelas...')
  
  const sqlScript = `-- Script para criar tabelas do MentoriaApp
-- Execute este SQL no Supabase Dashboard ‚Üí SQL Editor

-- 1. Tabela de usu√°rios (mentores e alunos)
CREATE TABLE IF NOT EXISTS usuarios (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  nome TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  senha TEXT NOT NULL,
  tipo TEXT CHECK (tipo IN ('mentor', 'aluno')) NOT NULL,
  telefone TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Tabela de configura√ß√µes dos mentores
CREATE TABLE IF NOT EXISTS configuracoes_mentor (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  mentor_id UUID REFERENCES usuarios(id) ON DELETE CASCADE,
  horarios_disponiveis JSONB DEFAULT '{}',
  preco_por_hora DECIMAL(10,2) DEFAULT 0,
  especialidades TEXT[] DEFAULT '{}',
  bio TEXT,
  ativo BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Tabela de agendamentos
CREATE TABLE IF NOT EXISTS agendamentos (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  aluno_id UUID REFERENCES usuarios(id) ON DELETE CASCADE,
  mentor_id UUID REFERENCES usuarios(id) ON DELETE CASCADE,
  data_agendamento DATE NOT NULL,
  horario TIME NOT NULL,
  assunto TEXT NOT NULL,
  status TEXT CHECK (status IN ('pendente', 'confirmado', 'recusado', 'cancelado', 'concluido')) DEFAULT 'pendente',
  motivo_recusa TEXT,
  observacoes TEXT,
  link_call TEXT,
  gravacao_url TEXT,
  telefone TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. √çndices para melhor performance
CREATE INDEX IF NOT EXISTS idx_usuarios_email ON usuarios(email);
CREATE INDEX IF NOT EXISTS idx_usuarios_tipo ON usuarios(tipo);
CREATE INDEX IF NOT EXISTS idx_agendamentos_mentor ON agendamentos(mentor_id);
CREATE INDEX IF NOT EXISTS idx_agendamentos_aluno ON agendamentos(aluno_id);
CREATE INDEX IF NOT EXISTS idx_agendamentos_data ON agendamentos(data_agendamento);
CREATE INDEX IF NOT EXISTS idx_agendamentos_status ON agendamentos(status);

-- 5. Inserir dados de exemplo (opcional)
INSERT INTO usuarios (nome, email, senha, tipo, telefone) VALUES
('Jo√£o Mentor', 'joao@mentor.com', 'senha123', 'mentor', '(11) 99999-1111'),
('Maria Aluna', 'maria@aluna.com', 'senha123', 'aluno', '(11) 99999-2222')
ON CONFLICT (email) DO NOTHING;

-- Mensagem de sucesso
SELECT 'Tabelas criadas com sucesso! üéâ' as resultado;
`
  
  try {
    fs.writeFileSync('scripts/criar-tabelas-completas.sql', sqlScript)
    console.log('‚úÖ Script SQL criado: scripts/criar-tabelas-completas.sql')
    console.log('üìã Execute este SQL no Supabase Dashboard!')
    return true
  } catch (error) {
    console.log(`‚ùå Erro ao criar script: ${error.message}`)
    return false
  }
}

// Fun√ß√£o principal
async function executarCorrecoes() {
  console.log('üöÄ Iniciando corre√ß√µes autom√°ticas...\n')
  
  let problemas = 0
  let correcoes = 0
  
  // Passo 1: Verificar arquivo .env
  if (!verificarArquivoEnv()) {
    problemas++
    console.log('‚ùå Problema: Arquivo .env.local n√£o configurado')
  } else {
    correcoes++
  }
  
  // Passo 2: Testar conex√£o
  const credentials = await testarConexaoBasica()
  if (!credentials) {
    problemas++
    console.log('‚ùå Problema: Conex√£o com Supabase falhou')
  } else {
    correcoes++
    
    // Passo 3: Verificar tabelas
    const tabelasOk = await verificarTabelas(credentials)
    if (!tabelasOk) {
      problemas++
      console.log('‚ùå Problema: Tabelas do banco n√£o existem ou est√£o com erro')
      
      // Criar script SQL para resolver
      if (criarScriptSQL()) {
        console.log('‚úÖ Script de corre√ß√£o criado!')
      }
    } else {
      correcoes++
    }
  }
  
  // Resultado final
  console.log('\n' + '='.repeat(50))
  console.log('üìä RESULTADO DAS CORRE√á√ïES')
  console.log('='.repeat(50))
  console.log(`‚úÖ Corre√ß√µes aplicadas: ${correcoes}`)
  console.log(`‚ùå Problemas encontrados: ${problemas}`)
  
  if (problemas === 0) {
    console.log('\nüéâ PARAB√âNS! Tudo est√° funcionando perfeitamente!')
    console.log('‚úÖ Seu Supabase est√° pronto para uso')
    console.log('üöÄ Execute: node scripts/auditoria-completa-supabase.js para confirmar')
  } else {
    console.log('\n‚ö†Ô∏è  Ainda existem problemas para resolver:')
    
    if (problemas >= 2) {
      console.log('1. Configure o arquivo .env.local com suas credenciais')
      console.log('2. Execute o SQL: scripts/criar-tabelas-completas.sql no Supabase')
    } else if (problemas === 1) {
      console.log('1. Execute o SQL: scripts/criar-tabelas-completas.sql no Supabase')
    }
    
    console.log('3. Execute este script novamente para verificar')
  }
  
  console.log('\nüìã PR√ìXIMOS PASSOS:')
  console.log('1. Resolva os problemas listados acima')
  console.log('2. Execute: node scripts/corrigir-problemas-supabase.js (este script)')
  console.log('3. Execute: node scripts/auditoria-completa-supabase.js (auditoria completa)')
}

// Executar corre√ß√µes
executarCorrecoes().catch(error => {
  console.error('‚ùå Erro cr√≠tico:', error.message)
  console.log('\nüîß Tente executar manualmente cada passo:')
  console.log('1. Verifique se o arquivo .env.local existe')
  console.log('2. Configure as credenciais do Supabase')
  console.log('3. Teste a conex√£o manualmente')
})
